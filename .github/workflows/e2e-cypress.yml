name: E2E (Cypress)

on:
  push:
    paths:
      - "server/**"
      - "web/**"
      - ".github/workflows/e2e-cypress.yml"
  pull_request:
    paths:
      - "server/**"
      - "web/**"
      - ".github/workflows/e2e-cypress.yml"

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install backend deps
        working-directory: server
        run: npm ci

      - name: Install frontend deps
        working-directory: web
        run: npm ci

      - name: Start API
        working-directory: server
        env:
          PORT: "4000"
          DATABASE_PATH: "${{ github.workspace }}/server/data/e2e.db"
        run: |
          npm start &
          echo "Waiting for API..."
          npx wait-on --timeout 20000 tcp:4000 || (echo "API did not start" && exit 1)

      - name: Build web
        working-directory: web
        run: npm run build

      - name: Preview web (5173)
        working-directory: web
        env:
          VITE_API_URL: "http://localhost:4000"
        run: |
          npx vite preview --host --port 5173 &
          echo "Waiting for web..."
          npx wait-on --timeout 20000 http://localhost:5173 || (echo "Web did not start" && exit 1)

      - name: Cypress run
        uses: cypress-io/github-action@v6
        with:
          working-directory: web
          browser: chrome
          config: baseUrl=http://localhost:5173
          env: apiUrl=http://localhost:4000
        env:
          # Needed for Chrome in some CI environments
          CYPRESS_INSTALL_BINARY: "0"
